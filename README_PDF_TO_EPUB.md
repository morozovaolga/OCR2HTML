# Единый пайплайн PDF → EPUB

Скрипт `pdf_to_epub.py` объединяет все этапы обработки от PDF до EPUB в одну команду, следуя точной схеме из `PIPELINE_SCHEMA.md`.

## Быстрый старт

### Минимальная команда

```bash
python pdf_to_epub.py --pdf book.pdf --title "Название книги" --author "Имя Автора" --epub-template sample.epub
```

Это выполнит:
1. Извлечение структуры из PDF
2. Применение правил старой орфографии (если не указан `--no-oldspelling`)
3. Модернизацию орфографии
4. Генерацию EPUB (если указан `--epub-template`)

**Примечание:** 
- По умолчанию проверки орфографии **не включены**
- **Рекомендуется:** `--lt-cloud --natasha-sync` для лучшего качества (79.61% точности)

## Примеры использования

### 1. Рекомендуемый вариант (лучшее качество) ⭐

```bash
python pdf_to_epub.py \
  --pdf karp.pdf \
  --title "Карп" \
  --author "Тэффи" \
  --lt-cloud \
  --natasha-sync \
  --epub-template sample.epub \
  --cover-colors "#ffbe0b,#fb5607,#ff006e,#8338ec,#3a86ff"
```

**Результат:** EPUB файл в папке `out/` с автоматически сгенерированной обложкой.

**Качество:** 79.61% точности слов, ~11 секунд обработки

**Что делает:**
1. Извлечение структуры из PDF
2. Применение правил старой орфографии
3. Модернизация орфографии
4. LanguageTool проверка орфографии
5. Natasha синхронизация имен (исправляет ошибки OCR в именах)
6. Генерация EPUB

### 2. Быстрый вариант (хорошее качество)

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название" \
  --author "Автор" \
  --lt-cloud \
  --epub-template sample.epub
```

**Качество:** 79.42% точности слов, ~5 секунд обработки

**Что делает:** LanguageTool проверка орфографии без синхронизации имен.

### 3. Базовый вариант (без проверок)

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название" \
  --author "Автор" \
  --epub-template sample.epub
```

**Качество:** 73.90% точности слов, ~1 секунда обработки

**Что делает:** Только модернизация орфографии без проверок.

### 4. PDF с двумя колонками

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название" \
  --author "Автор" \
  --two-columns
```

**Что делает:** Правильно обрабатывает PDF с двумя колонками на странице.

### 5. Без старой орфографии

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название" \
  --author "Автор" \
  --no-oldspelling
```

**Что делает:** Пропускает применение правил дореформенной орфографии.

### 6. Только обработка PDF (без EPUB)

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название" \
  --author "Автор"
```

**Что делает:** Обрабатывает PDF, но не создает EPUB файл (так как не указан `--epub-template`).

## Параметры

### Обязательные параметры

- `--pdf` — путь к PDF файлу
- `--title` — название книги

### Основные параметры

- `--author` — автор книги (для обложки EPUB)
- `--outdir` — папка для результатов (по умолчанию: `out`)

### Параметры обработки PDF

- `--two-columns` — PDF с двумя колонками на странице
- `--no-oldspelling` — пропустить применение правил старой орфографии

### Параметры проверки орфографии

**Рекомендуемые:**
- `--lt-cloud` — использовать LanguageTool (облачная проверка орфографии) ⭐ РЕКОМЕНДУЕТСЯ
- `--chunk-size` — размер чанка для LanguageTool (по умолчанию: 6000)
- `--context-check` — контекстная проверка (местоимение+глагол, создает отчет, не меняет текст)
- `--context-out` — файл с предупреждениями контекстной проверки (по умолчанию: `context_warnings.txt`)
- `--context-pronouns` — местоимения для контекстной проверки (по умолчанию: `он,она,оно,они,мы,вы,ты`)

### Параметры EPUB

- `--epub-template` — путь к шаблону EPUB (если указан, генерирует EPUB; по умолчанию: `sample.epub`)
- `--cover-colors` — пять HEX-цветов через запятую (полоска, верхний блок, заголовок, градиент начало, градиент конец)
- `--epub-max-chapter-size` — максимальный размер главы в KB (по умолчанию: 50)

### Дополнительные проверки (параллельно)

**Natasha — проверка и синхронизация именованных сущностей (имена, места, организации)**

Natasha сверяет имена в обработанном тексте с именами из исходного PDF и помогает исправить ошибки OCR в именах собственных.

- `--natasha-check` — сравнение именованных сущностей между PDF и final_clean.txt (создает отчет, не меняет текст)
- `--natasha-types` — типы сущностей для Natasha (по умолчанию: `PER,LOC`). Доступны: `PER` (имена людей), `LOC` (места), `ORG` (организации)
- `--natasha-out` — файл отчета Natasha проверки (по умолчанию: `natasha_diff.txt`)
- `--natasha-sync` — **синхронизация именованных сущностей**: заменяет имена в обработанном тексте на версии из PDF (например, "Иван" → "Иван Петрович")
- `--natasha-sync-report` — файл отчета Natasha синхронизации (по умолчанию: `natasha_sync.txt`)

**Пример использования:**
```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название" \
  --author "Автор" \
  --lt-cloud \
  --natasha-check \
  --natasha-sync \
  --natasha-types PER,LOC \
  --epub-template sample.epub
```

**Что делает:**
1. `--natasha-check` — находит имена в PDF и обработанном тексте, сравнивает их и создает отчет о различиях
2. `--natasha-sync` — автоматически заменяет имена в обработанном тексте на версии из PDF (исправляет ошибки OCR в именах)

### Параметры токенизации (опционально, рекомендуется)

- `--stanza-tokenize` — улучшить разбиение на предложения через Stanza (рекомендуется для лучшего качества)
- `--stanza-model` — путь к модели Stanza (.pt файл, например: `stanza_rubicdata_tokenizer.pt`)

**Что делает:** Улучшает разбиение текста на предложения после OCR, что помогает LanguageTool работать более точно.

**Требования:** 
- Установленная библиотека Stanza (`pip install stanza~=1.8.1`)
- Модель токенизатора НКРЯ (скачайте с https://ruscorpora.ru/license-content/neuromodels)

## Результаты тестирования качества

На основе тестирования различных комбинаций проверок на образце `karp.txt`:

| Комбинация | Точность слов | Время | Рекомендация |
|------------|---------------|-------|--------------|
| LanguageTool + Natasha-sync | **79.61%** | ~11 сек | ⭐ Лучший вариант |
| LanguageTool | 79.42% | ~5 сек | ✅ Быстрый вариант |
| Только модернизация | 73.90% | ~1 сек | Базовый вариант |
| LanguageTool + Post-clean | 77.27% | ~6 сек | ❌ Устарело |
| pyspellchecker + LanguageTool | 24-52% | ~90 сек | ❌ Устарело |

**Выводы:**
- ✅ **Используйте:** `--lt-cloud --natasha-sync` для лучшего качества (79.61%)
- ✅ **Используйте:** `--lt-cloud` для быстрой обработки (79.42%)
- ❌ **Не используйте:** `--post-clean` (снижает точность до 77.27%)
- ❌ **Не используйте:** `--local-spell` с pyspellchecker (ухудшает до 24-52%)

## Порядок этапов обработки

Пайплайн следует точной схеме из `PIPELINE_SCHEMA.md`:

1. **Извлечение структуры** (обязательно) — `extract_structured_text.py`
2. **Применение правил oldspelling** (опционально) — `apply_rules_structured.py`
3. **Stanza токенизация** (опционально) — `stanza_tokenizer.py`
4. **Модернизация орфографии** (всегда) — `modernize_structured.py`
5. **Локальная проверка орфографии** (опционально) — `local_spell_checker.py`
6. **LanguageTool** (опционально) — `lt_cloud.py`
7. **Контекстная проверка** (опционально) — `context_checker.py`
8. **Генерация EPUB** (опционально) — `generate_epub.py`

**Дополнительные проверки (параллельно):**
- Natasha проверка — `natasha_entity_check.py`
- Natasha синхронизация — `natasha_sync.py`

## Рекомендуемые команды

### ⭐ Для максимального качества (РЕКОМЕНДУЕТСЯ)

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название книги" \
  --author "Имя Автора" \
  --stanza-tokenize \
  --stanza-model stanza_rubicdata_tokenizer.pt \
  --lt-cloud \
  --natasha-sync \
  --epub-template sample.epub \
  --cover-colors "#ffbe0b,#fb5607,#ff006e,#8338ec,#3a86ff"
```

**Результаты тестов:** 79.61% точности слов (без Stanza), ~11 секунд обработки

**Почему:** 
- **Stanza токенизация** — улучшает разбиение на предложения (помогает LanguageTool работать лучше)
- **LanguageTool** — дает 79.42% точности
- **Natasha-sync** — добавляет +0.19% точности (исправляет ошибки OCR в именах)
- Лучшая комбинация по результатам тестирования

**Примечание:** Stanza токенизация опциональна — если модель не указана или не найдена, пайплайн пропустит этот этап.

### ✅ Для быстрой обработки

```bash
python pdf_to_epub.py \
  --pdf book.pdf \
  --title "Название книги" \
  --author "Имя Автора" \
  --lt-cloud \
  --epub-template sample.epub
```

**Результаты тестов:** 79.42% точности слов, ~5 секунд обработки

**Почему:** Использует только LanguageTool (быстро и эффективно, без синхронизации имен).


## Что происходит внутри

Скрипт последовательно выполняет этапы согласно схеме `PIPELINE_SCHEMA.md`:

1. **Извлечение структуры** (обязательно) — `extract_structured_text.py`
   - Выход: `structured.json`, `structured.html`, `structured.txt`

2. **Применение правил oldspelling** (опционально) — `apply_rules_structured.py`
   - Выход: `structured_rules.json`

3. **Stanza токенизация** (опционально) — `stanza_tokenizer.py`
   - Выход: `structured_tokenized.json`

4. **Модернизация орфографии** (всегда) — `modernize_structured.py`
   - Выход: `final.html`, `final.txt`, `flags.json`

5. **LanguageTool** (опционально, рекомендуется) — `lt_cloud.py` ⭐
   - Выход: `final_clean.txt/html`

6. **Контекстная проверка** (опционально) — `context_checker.py`
   - Выход: `context_warnings.txt` (отчет, не меняет текст)

7. **Генерация EPUB** (опционально) — `generate_epub.py`
    - Использует лучший доступный источник (по приоритету из схемы)
    - Выход: `book.epub`

## Результаты

После выполнения в папке `out/` будут созданы:

- `structured.json` — структурированные блоки текста
- `final.txt` — модернизированный текст
- `final_clean.txt` — после LanguageTool (если включено)
- `Название_книги.epub` — финальный EPUB файл

## Советы

1. **Используйте `final_clean.txt`** — это лучший вариант после LanguageTool проверки
2. **Проверяйте EPUB** — откройте созданный EPUB в читалке и проверьте качество
3. **Настройте цвета обложки** — используйте `--cover-colors` для красивого дизайна
4. **Для больших книг** — увеличьте `--epub-max-chapter-size` если главы слишком маленькие
5. **Используйте Natasha-sync** — для исправления ошибок OCR в именах собственных

## Пример полной команды (рекомендуется)

```bash
python pdf_to_epub.py \
  --pdf "D:/My projects/ocr2epub/karp.pdf" \
  --outdir "out" \
  --title "Карп" \
  --author "Тэффи" \
  --two-columns \
  --stanza-tokenize \
  --stanza-model stanza_rubicdata_tokenizer.pt \
  --lt-cloud \
  --natasha-sync \
  --context-check \
  --epub-template sample.epub \
  --cover-colors "#ffbe0b,#fb5607,#ff006e,#8338ec,#3a86ff" \
  --epub-max-chapter-size 50
```

Это выполнит обработку с рекомендуемыми проверками (79.61% точности) и создаст EPUB файл.

